# v3.1 模型工作原理：用故事讲解

> *本文档用通俗的语言，讲述 v3.1 PPG 分析模型的工作过程。*

---

## 故事背景：医院里的"噪声危机"

想象你是一位急诊室的心脏科医生。你的任务是快速判断病人的心跳是否正常。

你面前有一台老式的 PPG 监护仪，它会显示病人手指上的脉搏波形。正常情况下，你可以从波形的形状（是平滑的正弦波？还是有突然的"早跳"？）来诊断病人是**窦性心律**还是**早搏**。

然而，问题来了：

- 病人在床上翻了个身，**手臂晃动了一下**。
- 护士推门进来，病人下意识地**握紧了拳头**。

这些动作产生的"噪声"会混入脉搏信号，波形变得"杂乱无章"。

**你该怎么判断？**

- 如果你说"这是噪声，忽略它"——那你可能漏掉了真正的心律失常。
- 如果你说"这是心律失常！"——那你可能误诊，给正常人开错药。

这就是我们的模型要解决的问题。

---

## 第一幕：单眼时代 (v2.4)

在最初的版本 (v2.4) 中，我们的模型就像一个**只有一只眼睛的医生**。

它只能看到波形的"形状"（时域信号）。当波形清晰时，它能准确判断是正常心跳还是早搏，准确率高达 **98.5%**。

但是，一旦信号被噪声污染，它就傻眼了。它无法区分"这是手在抖"还是"这是心律失常"。

**结果**：在有噪声的信号上，诊断准确率骤降到 **60%** 甚至更低。

---

## 第二幕：复眼升级 (v3.0)

我们意识到，单眼只能看到"时间"，但无法看到"频率"。

于是，我们给模型装上了**复眼**——一种昆虫那样的多维感知能力。

### "复眼"是什么？

**连续小波变换 (CWT)** 就像一副特殊的眼镜，可以把信号"拆分"成 32 个频率层。

- **低频层**：能看到心跳的节奏（每秒 1-2 次的缓慢起伏）。
- **高频层**：能看到噪声的"毛刺"（手抖产生的 10-50Hz 震荡）。

当病人的手抖了一下，低频层仍然显示正常的心跳节奏，而高频层会"亮起红灯"——一道突然出现的"能量爆发"。

模型看到这个现象，就知道："**这一段是噪声！**"

### v3.0 的成就与遗憾

**成就**：噪声识别准确率高达 **98.5%**。模型能准确地"找到"噪声发生的位置。

**遗憾**：但是，模型变得过于专注于"找噪声"，以至于忘记了自己的本职工作——诊断心律类型。心律分类准确率暴跌到 **19.5%**（基本是瞎猜）。

**原因**：训练时，我们给"找噪声"任务分配了过高的权重（10:1）。模型为了取悦这个任务，牺牲了分类能力。

---

## 第三幕：大脑升级 (v3.1)

问题的本质是：**复眼虽然好，但眼睛太多，反而让大脑分心了。**

我们需要一个更聪明的大脑——一个能在**合适的时候关注合适的眼睛**的机制。

### 引入"注意力"(SE-Block)

**Squeeze-and-Excitation (SE) Block** 就是这个"聪明的大脑"。

它的工作方式是这样的：

1. **收集信息**：首先，它把所有 34 个通道（2 个时域 + 32 个频率层）的信号汇总起来，看一眼"全局画面"。
2. **判断重要性**：然后，它计算每个通道的"重要性分数"。
   - 如果当前任务是"找噪声"，它会给高频层更高的分数。
   - 如果当前任务是"判断心律"，它会给低频的心跳节奏通道更高的分数。
3. **放大/缩小**：最后，它根据分数，放大重要通道的信号，缩小不重要通道的干扰。

这就像医生在看波形时，**选择性地戴上或摘下不同的滤镜**。

### 还有一个关键：平衡训练

除了注意力，我们还修复了训练策略：

- **旧策略**：噪声任务权重 10，分类任务权重 1。（模型只顾着找噪声）
- **新策略**：两者权重都是 1。（模型必须两个任务一起做好）

这就像老师布置作业："语文和数学同等重要，期末考试各占 50 分。"

---

## 故事结局：全能医生诞生

经过这两项升级，v3.1 模型成为了真正的**全能医生**：

| 指标 | v2.4 (单眼) | v3.0 (复眼但分心) | v3.1 (复眼+聪明大脑) |
|------|-------------|-------------------|----------------------|
| 噪声定位准确率 | 无 | 98.5% | **99.2%** |
| 心律分类准确率 | 98.5% | 19.5% | **99.9%** |

**它既能精准地找到噪声，又能透过噪声看清真正的心跳。**

---

## 工作流程总结

1. **输入**：8 秒的 PPG 信号。
2. **复眼处理**：信号被转换成 34 通道的张量（振幅 + 速度 + 32 层小波）。
3. **编码器 + 注意力**：UNet 编码器逐层提取特征，每层都有 SE-Block 动态调整通道权重。
4. **瓶颈特征**：压缩后的特征包含了"这段信号的精华"。
5. **双头输出**：
   - **分割头**：逐毫秒输出"这里是干净/基线漂移/前臂运动/手部运动/高频噪声"。
   - **分类头**：输出整段信号的心律类型："窦性/早搏/室早/融合波/未知"。
6. **结果**：医生（或下游系统）可以同时得到"哪里有问题"和"整体是什么类型"的答案。

---

## 一句话总结

> **v3.1 = 复眼 (CWT) + 聪明大脑 (SE-Attention) + 纪律 (平衡 Loss)**
>
> 它用小波看到噪声的"频率指纹"，用注意力选择性聚焦，用平衡训练保证两项能力并重。

---

*The End.*
